!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Ohbug=t()}(this,function(){"use strict";const e="uncaughtError",t="resourceError",r="grammarError",n="promiseError",o="ajaxError",s="fetchError";let i={delay:2e3};function a(e){return e&&(i={...i,...e}),i}const u=[];function c(){const e=new Date;let t={time:`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日${e.getHours()}时${e.getMinutes()}分${e.getSeconds()}秒`,userAgent:window.navigator.userAgent,url:window.location.href,title:document.title};return a().others&&(t={...t,...a().others}),t}let d;function p(e){const t="error",r="background: #d9634d; color: #fff; padding: 2px 4px; border-radius: 2px";console.log(`%c${t}`,r,e)}const l=window.location.host.indexOf("127.0.0.1")>-1||window.location.host.indexOf("localhost")>-1;function f(e){p(e),u.push({...c(),...e});const t=(r=(()=>{p(u),!l&&function(e){a().report&&a().report(e)}(u)}),n=a().delay,function(){const e=this,t=arguments;d&&clearTimeout(d),d=setTimeout(()=>{r.apply(e,t)},n)});var r,n;u.length&&t()}function h({type:o,e:s}){try{if("default"===o){const{message:n,filename:o,lineno:i,colno:a,error:u}=s;if(n){if(u){f({type:e,desc:{message:n,filename:o,row:i,col:a,error:u.stack||u}})}}else{const e=s.target||s.srcElement;let n=s.target||s.srcElement;if(e){const{outerHTML:r}=e,o=function(){const e=[];for(let t=0;n&&n.nodeType===Node.ELEMENT_NODE&&n.nodeType!==Node.DOCUMENT_TYPE_NODE;n=n.previousSibling)t&&e.push(n),t+=1;return s&&s.path.reverse().map(t=>(t.localName||"")+(t.id?`#${t.id}`:"")+(t.className?`.${t.className}`:"")+(t.outerHTML===r?`:nth-child(${e.length})`:"")).filter(e=>e).join(" > ")}();f({type:t,desc:{outerHTML:r,src:e&&e.src,tagName:e&&e.tagName,id:e&&e.id,className:e&&e.className,name:e&&e.name,type:e&&e.type,selector:o,timeStamp:s.timeStamp}})}else if("string"==typeof s){f({type:r,desc:s})}}}else if("promise"===o){f({type:n,desc:{message:s.reason.message||s.reason,error:s.reason.stack||s.reason}})}return!1}catch(e){f(e)}}function m(){}return m.init=function(e){e&&a(e),window&&(window.addEventListener&&window.addEventListener("error",e=>{h({type:"default",e:e})},!0),window.addEventListener&&window.addEventListener("unhandledrejection",e=>{e.preventDefault(),h({type:"promise",e:e})},!0),function(){window.XMLHttpRequest&&{reqUrl:"",reqMethod:"",xhrOpen:window.XMLHttpRequest.prototype.open,xhrSend:window.XMLHttpRequest.prototype.send,init(){const e=this;window.XMLHttpRequest.prototype.open=function(){e.reqUrl=arguments[1],e.reqMethod=arguments[0],e.xhrOpen.apply(this,arguments)},window.XMLHttpRequest.prototype.send=function(){const t={...c(),type:o,req:{url:e.reqUrl,method:e.reqMethod,data:arguments[0]||{}},res:{status:0,statusText:"",response:null}};this.addEventListener("readystatechange",function(){4===this.readyState&&(t.res.response=this.response,t.res.status=this.status,t.res.statusText=this.statusText,(!this.status||this.status>=400)&&f(t))}),e.xhrSend.apply(this,arguments)}}}.init();if(window.fetch){const e={backup:window.fetch,init(){window.fetch=function(t,r){return e.backup.apply(this,arguments).then(e=>{const n={...c(),type:s,req:{url:t,method:r&&r.method||"GET",data:r&&r.body||{}},res:{status:e.status,statusText:e.statusText}};return(!e.status||e.status>=400)&&f(n),e}).catch(e=>{f(e)})}}};e.init()}}())},m.caughtError=((e,t,r)=>"function"==typeof r.value?{...r,value(){try{return r.value&&r.value.apply(this,arguments)}catch(e){throw f({type:"caughtError",desc:{method:t,params:arguments,error:e.stack||e}}),e}}}:"function"==typeof r.initializer?{enumerable:!0,configurable:!0,get(){return r.initializer&&r.initializer.apply(this)}}:void 0),m.reportError=(e=>{f({type:"reportError",desc:e})}),m});
