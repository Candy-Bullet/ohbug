!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Ohbug=t()}(this,function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{},o=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),o.forEach(function(n){e(t,n,r[n])})}return t}var n,r="uncaughtError",o="resourceError",i="grammarError",a="promiseError",c="ajaxError",u="fetchError";function d(){var e=window.$OhbugConfig,n=new Date,r={time:"".concat(n.getFullYear(),"年").concat(n.getMonth()+1,"月").concat(n.getDate(),"日").concat(n.getHours(),"时").concat(n.getMinutes(),"分").concat(n.getSeconds(),"秒"),userAgent:window.navigator.userAgent,url:window.location.href,title:document.title,preUrl:document.referrer&&document.referrer!==window.location.href?document.referrer:""};return e&&e.others&&(r=t({},r,e.others)),r}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;[{type:0,msg:"log",style:"background: #e4f1eb; color: #fff; padding: 2px 4px; border-radius: 2px"},{type:1,msg:"info",style:"background: #007fff; color: #fff; padding: 2px 4px; border-radius: 2px"},{type:2,msg:"error",style:"background: #d9634d; color: #fff; padding: 2px 4px; border-radius: 2px"}].forEach(function(n){t===n.type&&console.log("%c".concat(n.msg),n.style,e)})}var f=/^(https?:\/\/)?(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(.+)?$/.test(window.location.host)||window.location.host.indexOf("localhost")>-1;function l(e){try{var t=window.$OhbugConfig;f?t&&t.enabledDev&&t.report&&t.report(e):t&&t.report&&t.report(e)}catch(e){s("发送日志失败 errorInfo:".concat(e))}}var p=[],g=function(e){return function(e,t){return function(){var r=this,o=arguments;n&&clearTimeout(n),n=setTimeout(function(){e.apply(r,o)},t)}}(function(){s(p),l(p)},e).call()};function h(e){s(e),p.push(t({},d(),e));var n=window.$OhbugConfig;n&&n.error&&("immediately"===n.mode||!n.mode)&&p.length&&p.length<=n.maxError&&g(n&&n.delay||2e3)}function w(e){var t=e.type,n=e.e;try{if("default"===t){var c=n.message,u=n.filename,d=n.lineno,s=n.colno,f=n.error;if(c){if(f)h({type:r,desc:{message:c,filename:u,row:d,col:s,error:f.stack||f}})}else{var l=n.target||n.srcElement,p=n.target||n.srcElement;if(l){var g=l.outerHTML,w=function(){for(var e=[],t=0;p&&p.nodeType===Node.ELEMENT_NODE&&p.nodeType!==Node.DOCUMENT_TYPE_NODE;p=p.previousSibling)t&&e.push(p),t+=1;return n&&n.path.reverse().map(function(t){return(t.localName||"")+(t.id?"#".concat(t.id):"")+(t.className?".".concat(t.className):"")+(t.outerHTML===g?":nth-child(".concat(e.length,")"):"")}).filter(function(e){return e}).join(" > ")}();h({type:o,desc:{outerHTML:g,src:l&&l.src,tagName:l&&l.tagName,id:l&&l.id,className:l&&l.className,name:l&&l.name,type:l&&l.type,selector:w,timeStamp:n.timeStamp}})}else if("string"==typeof n){h({type:i,desc:n})}}}else if("promise"===t){h({type:a,desc:{message:n.reason.message||n.reason,error:n.reason.stack||n.reason}})}return!1}catch(e){h(e)}}function m(){try{if(window){if(!window.performance)return new Error("performance is not supported");var e=performance.getEntriesByType("resource");return e&&e.length?e.map(function(e){return{name:e.name,type:e.initiatorType,duration:e.duration||0,decodedBodySize:e.decodedBodySize||0,nextHopProtocol:e.nextHopProtocol}}):[]}}catch(e){s(e)}}function y(){try{if(window.localStorage){var e=new Date,t=localStorage.getItem("$OhbugUV")||"",n=localStorage.getItem("$OhbugUVTime")||"";if(!t&&!n||e.getTime()>1*n){t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),localStorage.setItem("$OhbugUV",t);var r="".concat(e.getFullYear(),"/").concat(e.getMonth()+1,"/").concat(e.getDate()," 23:59:59");localStorage.setItem("$OhbugUVTime",new Date(r).getTime())}return t}}catch(e){s(e)}}function x(){window.addEventListener&&window.addEventListener("error",function(e){w({type:"default",e:e})},!0),window.addEventListener&&window.addEventListener("unhandledrejection",function(e){e.preventDefault(),w({type:"promise",e:e})},!0),function(){var e=window.$OhbugConfig.ignore;if(window.XMLHttpRequest&&{reqUrl:"",reqMethod:"",xhrOpen:window.XMLHttpRequest.prototype.open,xhrSend:window.XMLHttpRequest.prototype.send,init:function(){var n=this;window.XMLHttpRequest.prototype.open=function(){n.reqUrl=arguments[1],n.reqMethod=arguments[0],n.xhrOpen.apply(this,arguments)},window.XMLHttpRequest.prototype.send=function(){var r=t({},d(),{type:c,req:{url:n.reqUrl,method:n.reqMethod,data:arguments[0]||{}},res:{status:0,statusText:"",response:null}});this.addEventListener("readystatechange",function(){if(4===this.readyState){r.res.response=this.response,r.res.status=this.status,r.res.statusText=this.statusText;var t=e.filter(function(e){return n.reqUrl.indexOf(e)>-1});(!this.status||this.status>=400)&&!t.length&&h(r)}}),n.xhrSend.apply(this,arguments)}}}.init(),window.fetch){var n={backup:window.fetch,init:function(){window.fetch=function(r,o){return n.backup.apply(this,arguments).then(function(n){var i=t({},d(),{type:u,req:{url:r,method:o&&o.method||"GET",data:o&&o.body||{}},res:{status:n.status,statusText:n.statusText}}),a=e.filter(function(e){return r.indexOf(e)>-1});return(!n.status||n.status>=400)&&!a.length&&h(i),n}).catch(function(e){h(e)})}}};n.init()}}(),window.$OhbugConfig&&"beforeunload"===window.$OhbugConfig.mode&&window.addEventListener&&window.addEventListener("unload",function(){p.length&&p.length<=window.$OhbugConfig.maxError&&l(p)},!0),window.$OhbugConfig&&window.$OhbugConfig.performance&&window.addEventListener&&window.addEventListener("load",function(){var e=function(){try{if(window){if(!window.performance)return new Error("performance is not supported");var e=window.performance.timing,t=e.connectEnd,n=e.connectStart,r=e.domComplete,o=e.domContentLoadedEventEnd,i=e.domContentLoadedEventStart,a=e.domInteractive,c=e.domLoading,u=e.domainLookupEnd,d=e.domainLookupStart,f=e.fetchStart,l=e.loadEventEnd,p=e.loadEventStart,g=e.navigationStart,h=e.redirectEnd,w=e.redirectStart,m=e.requestStart,y=e.responseEnd,x=e.responseStart,b=e.secureConnectionStart;return{redirect:h-w||0,cache:d-f||0,dns:u-d||0,tcp:t-n||0,secureConnection:b?t-b:0,request:y-m||0,first:x-g||0,unload:e.unloadEventEnd-e.unloadEventStart||0,network:y-g||0,domInteractive:a-c||0,script:o-i||0,dom:r-a||0,onload:l-p||0,total:l-g||0}}}catch(e){s(e)}}(),n=m(),r=y(),o=t({},d());e&&(o.performance=e),n&&n.length&&(o.resource=n),r&&(o.UV=r),l(o)},!0)}function b(){}return b.init=function(e){window?(window.$OhbugAuth=!0,window.$OhbugConfig||(window.$OhbugConfig={delay:2e3,report:function(){},enabledDev:!1,maxError:10,mode:"immediately",ignore:[],error:!0,performance:!1,include:null}),e&&(window.$OhbugConfig=t({},window.$OhbugConfig,e)),window.$OhbugAuth&&x()):console.error("Ohbug: 检测到当前环境不支持 Ohbug！")},b.caughtError=function(e,n,r){if(window.$OhbugAuth){if("function"==typeof r.value)return t({},r,{value:function(){try{return r.value&&r.value.apply(this,arguments)}catch(e){throw h({type:"caughtError",desc:{method:n,params:arguments,error:e.stack||e}}),e}}});if("function"==typeof r.initializer)return{enumerable:!0,configurable:!0,get:function(){return r.initializer&&r.initializer.apply(this)}}}else console.error("Ohbug: 检测到未执行 Ohbug.init()")},b.reportInfo=function(e,t){if(window.$OhbugAuth){var n=window.$OhbugConfig,r={type:"reportInfo",desc:e};n.include?"function"==typeof n.include?n.include()&&t&&h(r):console.error("Ohbug: 参数 include 类型必须为 function"):!n.include&&t?console.error("Ohbug: Ohbug.init 未传入参数 include"):n.include||t||h(r)}else console.error("Ohbug: 检测到未执行 Ohbug.init()")},b});
