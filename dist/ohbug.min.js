!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Ohbug=t()}(this,function(){"use strict";const e="uncaughtError",t="resourceError",n="grammarError",o="promiseError",r="ajaxError",i="fetchError";function a(){const e=window.$OhbugConfig,t=new Date;let n={time:`${t.getFullYear()}年${t.getMonth()+1}月${t.getDate()}日${t.getHours()}时${t.getMinutes()}分${t.getSeconds()}秒`,userAgent:window.navigator.userAgent,url:window.location.href,title:document.title,preUrl:document.referrer&&document.referrer!==window.location.href?document.referrer:""};return e&&e.others&&(n={...n,...e.others}),n}let d;function s(e,t=2){[{type:0,msg:"log",style:"background: #e4f1eb; color: #fff; padding: 2px 4px; border-radius: 2px"},{type:1,msg:"info",style:"background: #007fff; color: #fff; padding: 2px 4px; border-radius: 2px"},{type:2,msg:"error",style:"background: #d9634d; color: #fff; padding: 2px 4px; border-radius: 2px"}].forEach(n=>{t===n.type&&console.log(`%c${n.msg}`,n.style,e)})}const c=/^(https?:\/\/)?(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(.+)?$/.test(window.location.host)||window.location.host.indexOf("localhost")>-1;function u(e){try{const t=window.$OhbugConfig;c?t&&t.enabledDev&&t.report&&t.report(e):t&&t.report&&t.report(e)}catch(e){s(`发送日志失败 errorInfo:${e}`)}}const l=[],f=(p=(()=>{s(l),u(l)}),g=window.$OhbugConfig&&window.$OhbugConfig.delay||2e3,function(){const e=this,t=arguments;d&&clearTimeout(d),d=setTimeout(()=>{p.apply(e,t)},g)});var p,g;function h(e){s(e),l.push({...a(),...e});const t=window.$OhbugConfig;t&&t.error&&("immediately"===t.mode||!t.mode)&&l.length&&l.length<=t.maxError&&f()}function w({type:r,e:i}){try{if("default"===r){const{message:o,filename:r,lineno:a,colno:d,error:s}=i;if(o){if(s){h({type:e,desc:{message:o,filename:r,row:a,col:d,error:s.stack||s}})}}else{const e=i.target||i.srcElement;let o=i.target||i.srcElement;if(e){const{outerHTML:n}=e,r=function(){const e=[];for(let t=0;o&&o.nodeType===Node.ELEMENT_NODE&&o.nodeType!==Node.DOCUMENT_TYPE_NODE;o=o.previousSibling)t&&e.push(o),t+=1;return i&&i.path.reverse().map(t=>(t.localName||"")+(t.id?`#${t.id}`:"")+(t.className?`.${t.className}`:"")+(t.outerHTML===n?`:nth-child(${e.length})`:"")).filter(e=>e).join(" > ")}();h({type:t,desc:{outerHTML:n,src:e&&e.src,tagName:e&&e.tagName,id:e&&e.id,className:e&&e.className,name:e&&e.name,type:e&&e.type,selector:r,timeStamp:i.timeStamp}})}else if("string"==typeof i){h({type:n,desc:i})}}}else if("promise"===r){h({type:o,desc:{message:i.reason.message||i.reason,error:i.reason.stack||i.reason}})}return!1}catch(e){h(e)}}function m(){try{if(window){if(!window.performance)return new Error("performance is not supported");const e=performance.getEntriesByType("resource");return e&&e.length?e.map(e=>({name:e.name,type:e.initiatorType,duration:e.duration||0,decodedBodySize:e.decodedBodySize||0,nextHopProtocol:e.nextHopProtocol})):[]}}catch(e){s(e)}}function x(){try{if(window.localStorage){const e=new Date;let t=localStorage.getItem("$OhbugUV")||"";const n=localStorage.getItem("$OhbugUVTime")||"";if(!t&&!n||e.getTime()>1*n){t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),localStorage.setItem("$OhbugUV",t);const n=`${e.getFullYear()}/${e.getMonth()+1}/${e.getDate()} 23:59:59`;localStorage.setItem("$OhbugUVTime",new Date(n).getTime())}return t}}catch(e){s(e)}}function y(){window.addEventListener&&window.addEventListener("error",e=>{w({type:"default",e:e})},!0),window.addEventListener&&window.addEventListener("unhandledrejection",e=>{e.preventDefault(),w({type:"promise",e:e})},!0),function(){const{ignore:e}=window.$OhbugConfig;window.XMLHttpRequest&&{reqUrl:"",reqMethod:"",xhrOpen:window.XMLHttpRequest.prototype.open,xhrSend:window.XMLHttpRequest.prototype.send,init(){const t=this;window.XMLHttpRequest.prototype.open=function(){t.reqUrl=arguments[1],t.reqMethod=arguments[0],t.xhrOpen.apply(this,arguments)},window.XMLHttpRequest.prototype.send=function(){const n={...a(),type:r,req:{url:t.reqUrl,method:t.reqMethod,data:arguments[0]||{}},res:{status:0,statusText:"",response:null}};this.addEventListener("readystatechange",function(){if(4===this.readyState){n.res.response=this.response,n.res.status=this.status,n.res.statusText=this.statusText;const o=e.filter(e=>t.reqUrl.indexOf(e)>-1);(!this.status||this.status>=400)&&!o.length&&h(n)}}),t.xhrSend.apply(this,arguments)}}}.init();if(window.fetch){const t={backup:window.fetch,init(){window.fetch=function(n,o){return t.backup.apply(this,arguments).then(t=>{const r={...a(),type:i,req:{url:n,method:o&&o.method||"GET",data:o&&o.body||{}},res:{status:t.status,statusText:t.statusText}},d=e.filter(e=>n.indexOf(e)>-1);return(!t.status||t.status>=400)&&!d.length&&h(r),t}).catch(e=>{h(e)})}}};t.init()}}(),window.$OhbugConfig&&"beforeunload"===window.$OhbugConfig.mode&&window.addEventListener&&window.addEventListener("unload",()=>{l.length&&l.length<=window.$OhbugConfig.maxError&&u(l)},!0),window.$OhbugConfig&&window.$OhbugConfig.performance&&window.addEventListener&&window.addEventListener("load",()=>{const e=function(){try{if(window){if(!window.performance)return new Error("performance is not supported");const{timing:e}=window.performance,{connectEnd:t,connectStart:n,domComplete:o,domContentLoadedEventEnd:r,domContentLoadedEventStart:i,domInteractive:a,domLoading:d,domainLookupEnd:s,domainLookupStart:c,fetchStart:u,loadEventEnd:l,loadEventStart:f,navigationStart:p,redirectEnd:g,redirectStart:h,requestStart:w,responseEnd:m,responseStart:x,secureConnectionStart:y,unloadEventEnd:b,unloadEventStart:E}=e;return{redirect:g-h||0,cache:c-u||0,dns:s-c||0,tcp:t-n||0,secureConnection:y?t-y:0,request:m-w||0,first:x-p||0,unload:b-E||0,network:m-p||0,domInteractive:a-d||0,script:r-i||0,dom:o-a||0,onload:l-f||0,total:l-p||0}}}catch(e){s(e)}}(),t=m(),n=x(),o={...a()};e&&(o.performance=e),t&&t.length&&(o.resource=t),n&&(o.UV=n),u(o)},!0)}function b(){}return b.init=function(e){window?(window.$OhbugAuth=!0,window.$OhbugConfig||(window.$OhbugConfig={delay:2e3,report(){},enabledDev:!1,maxError:10,mode:"immediately",ignore:[],error:!0,performance:!1,include:null}),e&&(window.$OhbugConfig={...window.$OhbugConfig,...e}),window.$OhbugAuth&&y()):console.error("Ohbug: 检测到当前环境不支持 Ohbug！")},b.caughtError=((e,t,n)=>{if(window.$OhbugAuth){if("function"==typeof n.value)return{...n,value(){try{return n.value&&n.value.apply(this,arguments)}catch(e){throw h({type:"caughtError",desc:{method:t,params:arguments,error:e.stack||e}}),e}}};if("function"==typeof n.initializer)return{enumerable:!0,configurable:!0,get(){return n.initializer&&n.initializer.apply(this)}}}else console.error("Ohbug: 检测到未执行 Ohbug.init()")}),b.reportInfo=((e,t)=>{if(window.$OhbugAuth){const n=window.$OhbugConfig,o={type:"reportInfo",desc:e};n.include?"function"==typeof n.include?n.include()&&t&&h(o):console.error("Ohbug: 参数 include 类型必须为 function"):!n.include&&t?console.error("Ohbug: Ohbug.init 未传入参数 include"):n.include||t||h(o)}else console.error("Ohbug: 检测到未执行 Ohbug.init()")}),b});
